<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>CSV Uploader for Salesforce</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">
    <div class="bg-white shadow-xl p-8 rounded-2xl w-full max-w-xl space-y-6">
        <h1 class="text-2xl font-bold text-gray-800 text-center">üì§ Upload CSV to Salesforce</h1>

        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Select Object</label>
            <input id="objectName" type="text" placeholder="e.g., Mass_Upload__c"
                class="w-full border border-gray-300 rounded-lg p-2" />
        </div>

        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Select CSV File</label>
            <input id="csvFile" type="file" accept=".csv" class="w-full border border-gray-300 rounded-lg p-2" />
        </div>

        <button onclick="uploadCsv()"
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded w-full">
            Upload to Salesforce
        </button>

        <div id="status" class="text-sm mt-4 text-gray-700 whitespace-pre-wrap"></div>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-4">
            <div id="uploadProgressBar" class="bg-green-500 h-4 rounded-full w-0 transition-all duration-300"></div>
        </div>
        <p id="progressText" class="text-sm mt-2 text-gray-700 text-center">0%</p>


    </div>

    <script>
        async function uploadCsv() {
            const objectName = document.getElementById("objectName").value.trim();
            const fileInput = document.getElementById("csvFile");
            const status = document.getElementById("status");
            const progressBar = document.getElementById("uploadProgressBar");
            const progressText = document.getElementById("progressText");

            const token = localStorage.getItem("sf_access_token");
            const instance = localStorage.getItem("sf_instance_url");

            if (!token || !instance) {
                alert("Missing Salesforce access token or instance URL.");
                return;
            }

            if (!objectName || !fileInput.files.length) {
                alert("Please provide object name and CSV file.");
                return;
            }

            // Read CSV content
            const file = fileInput.files[0];
            const text = await file.text();
            const rows = text.trim().split("\n");
            const headers = rows.shift().split(",");
            const records = rows.map(row => {
                const values = row.split(",");
                const record = {};
                headers.forEach((h, i) => record[h.trim()] = values[i]?.trim());
                return record;
            });

            const batchSize = 200;
            const total = records.length;
            let uploaded = 0;

            status.textContent = "‚è≥ Uploading records...";

            for (let i = 0; i < total; i += batchSize) {
                const chunk = records.slice(i, i + batchSize);

                const batch = chunk.map((record, idx) => ({
                    attributes: { type: objectName, referenceId: `ref_${i + idx}` },
                    ...record,
                }));

                const res = await fetch(`${window.origin}/upload-csv`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        object_name: objectName,
                        access_token: token,
                        instance_url: instance,
                        records: batch,
                    }),
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    status.textContent = `‚ùå Error uploading batch starting at record ${i + 1}:\n${errorText}`;
                    progressBar.style.width = `0%`;
                    progressText.textContent = `Failed`;
                    return;
                }

                uploaded += chunk.length;
                const percent = Math.floor((uploaded / total) * 100);
                progressBar.style.width = `${percent}%`;
                progressText.textContent = `${percent}%`;
            }

            status.textContent = `‚úÖ Successfully uploaded ${uploaded} records to ${objectName}.`;
        }

    </script>
</body>

</html>